---
import { getCollection } from "astro:content";
//import type { CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro"; // Usamos Layout.astro
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { SITE } from "@/config";

// 1. Generar rutas estÃ¡ticas para cada tag existente
export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tags = [...new Set(posts.flatMap(post => post.data.tags).filter(Boolean))];

  return tags.map(tag => {
    return {
      params: { tag: tag.toLowerCase() },
      props: { 
        tagName: tag, 
        posts: posts.filter(post => post.data.tags?.includes(tag)) 
      },
    };
  });
}

const { tagName, posts } = Astro.props;

const sortedPosts = posts.sort(
  (a, b) => b.data.pubDatetime.valueOf() - a.data.pubDatetime.valueOf()
);
---

<Layout title={`Tag: ${tagName} | ${SITE.title}`}>
  <Header />
  
  <main class="mx-auto max-w-3xl px-4 py-12">
    
    <div class="mb-12 border-b border-dashed border-foreground/20 pb-6">
      <p class="text-sm font-mono text-accent mb-2">TOPIC FILTER</p>
      <h1 class="text-4xl font-extrabold tracking-tight flex items-center gap-3">
        <span class="text-foreground/50">#</span>
        <span class="text-accent">{tagName}</span>
      </h1>
      <p class="mt-4 text-foreground/80">
        Mostrando {posts.length} {posts.length === 1 ? "entrada" : "entradas"} sobre este tema.
      </p>
    </div>

    <section class="space-y-16">
      {sortedPosts.map(post => {
        let imgSrc: string | undefined = undefined;
        if (post.data.ogImage) {
          if (typeof post.data.ogImage === 'string') {
            imgSrc = post.data.ogImage; 
          } else {
            imgSrc = post.data.ogImage.src; 
          }
        }

        return (
          <article>
            <a href={`/posts/${post.id}/`} class="group grid gap-4 sm:grid-cols-3 sm:gap-6">
              {imgSrc && (
                <div class="sm:col-span-1">
                  <img 
                    src={imgSrc} 
                    alt={post.data.title} 
                    class="rounded-lg shadow-md aspect-video object-cover transition-transform duration-300 group-hover:scale-105" 
                  />
                </div>
              )}
              <div class:list={["sm:col-span-2", { "sm:col-span-3": !imgSrc }]}>
                <h2 class="text-2xl font-semibold mb-2 text-accent group-hover:underline">
                  {post.data.title}
                </h2>
                <p class="mb-3 text-foreground/90 text-sm leading-relaxed">
                  {post.data.description}
                </p>
                <span class="text-xs font-mono text-foreground/60">
                  {post.data.pubDatetime.toLocaleDateString('es-ES', {
                    year: 'numeric', month: 'long', day: 'numeric'
                  })}
                </span>
              </div>
            </a>
          </article>
        );
      })}
    </section>

  </main>
  <Footer />
</Layout>